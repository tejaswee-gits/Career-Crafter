import React, { useState, useEffect, useRef } from 'react';
import { 
  Send, 
  Settings, 
  FileText, 
  Briefcase, 
  User, 
  CheckCircle2, 
  ChevronRight, 
  Play, 
  RotateCcw, 
  Save, 
  Trash2,
  Copy,
  ArrowRight,
  Sparkles,
  Link as LinkIcon,
  Upload,
  X,
  FileType,
  Image as ImageIcon,
  Info,
  Edit,
  Sliders,
  AlertTriangle,
  Factory,
  ArrowUp,
  ArrowDown,
  ChevronUp,
  ChevronDown,
  KeyRound,
  Linkedin,
  RefreshCw,
  MoreHorizontal,
  Wand2,
  GripVertical
} from 'lucide-react';

// --- MOCK DATA FOR DEMO MODE ---
const MOCK_RESPONSES = {
  score: `[[SCORE:72]]
| Category | Score | Critique |
| :--- | :--- | :--- |
| **Summary Impact** | 15/20 | Good summary, but lacks specific metrics. |
| **Experience** | 20/30 | Relevant roles, but duties are task-based, not result-based. |
| **Skills Match** | 25/30 | Strong technical match, missing some soft skills mentioned in JD. |
| **Language** | 10/10 | Clear and professional tone. |
| **ATS Check** | 2/10 | Two-column layout may cause parsing errors. |

**Critical Issues:**
1. **Lack of Metrics:** "Managed team" says nothing about scale. Use "Managed team of 10".
2. **Generic Summary:** Needs to be tailored to the specific industry keywords.
3. **Formatting:** The resume uses a complex layout that might confuse ATS.

**Verdict:** Interview (with reservations).`,
  gap: `**Gap Analysis:**

| Missing Skill | Importance | Actionable Fix |
| :--- | :--- | :--- |
| **Python** | High | Take a crash course or mention any scripting experience. |
| **Strategic Planning** | Medium | Reframe your "Project Management" bullets to highlight strategic decisions. |

**Strengths:**
* Strong background in Product Lifecycle Management.
* Excellent tenure at previous companies.

**Bridge Strategy:**
When asked about Python, discuss your proficiency in SQL and your ability to work closely with data science teams to define requirements.`,
  summary: `**Option 1: The Perfect Fit**
Senior Product Manager with 7+ years of experience in Fintech (SaaS). Proven track record of launching 3 successful payment products. Expert in Agile methodologies and stakeholder management, seeking to drive innovation at [Company Name].

**Option 2: The Disruptor**
Product Leader who delivered $5M in ARR within first year of product launch. scaled user base from 0 to 100k. Passionate about data-driven decision making and solving complex user problems in the financial sector.`,
  skills: `**Core Technical Skills:**
1. Product Roadmap Strategy
2. Agile & Scrum
3. Data Analysis (SQL, Tableau)
4. A/B Testing
5. JIRA / Confluence

**Keywords Table:**
| Keyword | Category | Priority |
| :--- | :--- | :--- |
| **SaaS** | Industry | High |
| **Stakeholder Mgmt** | Soft Skill | High |
| **Go-to-Market** | Technical | Med |`
};

// --- Score Chart Component ---
const ScoreChart = ({ score }) => {
  const radius = 30;
  const circumference = 2 * Math.PI * radius;
  const strokeDashoffset = circumference - (score / 100) * circumference;
  
  let color = "text-red-500";
  if (score >= 70) color = "text-yellow-500";
  if (score >= 85) color = "text-green-500";

  return (
    <div className="flex items-center gap-4 mb-4 bg-slate-50 p-4 rounded-xl border border-slate-100">
      <div className="relative w-20 h-20 flex items-center justify-center">
        <svg className="transform -rotate-90 w-20 h-20">
          <circle cx="40" cy="40" r={radius} stroke="currentColor" strokeWidth="8" fill="transparent" className="text-slate-200" />
          <circle cx="40" cy="40" r={radius} stroke="currentColor" strokeWidth="8" fill="transparent" strokeDasharray={circumference} strokeDashoffset={strokeDashoffset} className={`${color} transition-all duration-1000 ease-out`} strokeLinecap="round" />
        </svg>
        <span className={`absolute text-xl font-bold ${color}`}>{score}</span>
      </div>
      <div>
        <h4 className="font-bold text-slate-800 text-lg">Resume Score</h4>
        <p className="text-xs text-slate-500">Based on JD alignment & ATS standards.</p>
      </div>
    </div>
  );
};

// --- Improved Markdown Component ---
const MarkdownRenderer = ({ content }) => {
  if (!content) return null;

  // Extract Score if present (Format: [[SCORE:85]])
  const scoreMatch = content.match(/\[\[SCORE:(\d+)\]\]/);
  const score = scoreMatch ? parseInt(scoreMatch[1]) : null;
  const cleanContent = content.replace(/\[\[SCORE:\d+\]\]/, '');

  const lines = cleanContent.split('\n');
  const blocks = [];
  let currentTable = [];
  let inTable = false;

  lines.forEach((line) => {
    const trimmed = line.trim();
    // Detect table rows
    const isTableRow = trimmed.startsWith('|') && (trimmed.endsWith('|') || trimmed.split('|').length > 2);

    if (isTableRow) {
      inTable = true;
      currentTable.push(trimmed);
    } else {
      if (inTable) {
        if (currentTable.length > 0) blocks.push({ type: 'table', content: currentTable });
        currentTable = [];
        inTable = false;
      }
      blocks.push({ type: 'text', content: line });
    }
  });
  if (inTable && currentTable.length > 0) blocks.push({ type: 'table', content: currentTable });

  return (
    <div className="space-y-2 text-slate-800 leading-relaxed text-sm md:text-base">
      {score !== null && <ScoreChart score={score} />}
      {blocks.map((block, idx) => {
        if (block.type === 'table') return <TableBlock key={idx} lines={block.content} />;
        return <TextBlock key={idx} line={block.content} />;
      })}
    </div>
  );
};

const TableBlock = ({ lines }) => {
  if (!lines || lines.length < 2) return null;
  try {
    const headers = lines[0].split('|').filter(c => c.trim() !== '').map(c => c.trim());
    const rows = lines.slice(2).map(row => row.split('|').filter(c => c.trim() !== '').map(c => c.trim()));
    return (
      <div className="overflow-x-auto my-4 border border-slate-200 rounded-lg shadow-sm custom-scrollbar">
        <table className="min-w-full divide-y divide-slate-200 bg-white">
          <thead className="bg-slate-50">
            <tr>
              {headers.map((h, i) => (
                <th key={i} className="px-4 py-3 text-left text-xs font-bold text-slate-500 uppercase tracking-wider whitespace-nowrap">{formatBold(h)}</th>
              ))}
            </tr>
          </thead>
          <tbody className="divide-y divide-slate-200">
            {rows.map((row, i) => (
              <tr key={i} className={i % 2 === 0 ? 'bg-white' : 'bg-slate-50/50'}>
                {row.map((cell, j) => <td key={j} className="px-4 py-3 text-sm text-slate-700 whitespace-pre-wrap">{formatBold(cell)}</td>)}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    );
  } catch (e) { return <div className="p-2 bg-red-50 text-red-500 text-xs">Error rendering table</div>; }
};

const TextBlock = ({ line }) => {
  if (!line) return <div className="h-2"></div>;
  if (line.startsWith('### ')) return <h3 className="text-lg font-bold mt-6 mb-2 text-indigo-700">{line.replace('### ', '')}</h3>;
  if (line.startsWith('## ')) return <h2 className="text-xl font-bold mt-8 mb-3 text-indigo-800 border-b-2 border-indigo-50 pb-1">{line.replace('## ', '')}</h2>;
  if (line.startsWith('# ')) return <h1 className="text-2xl font-bold mt-8 mb-4 text-indigo-900 border-b pb-2">{line.replace('# ', '')}</h1>;
  if (line.trim().startsWith('- ')) return <li className="ml-4 list-disc marker:text-indigo-500 pl-1 my-1">{formatBold(line.replace('- ', ''))}</li>;
  if (line.trim().startsWith('* ')) return <li className="ml-4 list-disc marker:text-indigo-500 pl-1 my-1">{formatBold(line.replace('* ', ''))}</li>;
  const numberedMatch = line.match(/^(\d+)\. /);
  if (numberedMatch) return <div className="ml-4 flex gap-2 my-1"><span className="font-bold text-indigo-600 min-w-[20px]">{numberedMatch[1]}.</span><span>{formatBold(line.replace(/^\d+\. /, ''))}</span></div>;
  return <p className="mb-2">{formatBold(line)}</p>;
};

const formatBold = (text) => {
  if (typeof text !== 'string') return null; 
  const parts = text.split(/(\*\*.*?\*\*)/g);
  return parts.map((part, i) => {
    if (part.startsWith('**') && part.endsWith('**')) return <strong key={i} className="font-semibold text-slate-900">{part.slice(2, -2)}</strong>;
    return part;
  });
};

// --- Definitions ---

const MAIN_PROMPTS = [
  {
    id: 'score',
    title: "CV Scorecard (0-100)",
    desc: "Detailed scoring of your current CV against the JD.",
    requires: ['resume', 'jd'],
    customLabel: null,
    template: `You are a highly critical **Senior Talent Assessor**. 
**TASK:** Evaluate the provided Resume against the Job Description (JD).
**SCORING:**
Calculate a score out of 100 based on these weighted factors:
1. **Summary Impact (10%)**: Is it a generic objective or a value proposition?
2. **Experience Relevance (30%)**: Do the bullet points prove the skills required?
3. **Skill Match (30%)**: Are hard/soft skills present?
4. **Language & Tone (15%)**: Active voice vs passive. Metrics vs vague claims.
5. **ATS Compatibility (15%)**: Formatting, standard headings, keyword density.

**OUTPUT FORMAT:**
Start strictly with: [[SCORE:XX]] where XX is the total number.
Then provide:
1. **Score Breakdown Table:** | Category | Score | Critique |
2. **Critical Issues:** List the top 3 deal-breakers found.
3. **Verdict:** [Hire / Interview / Reject]

**MODE:** {scoreMode} (If Strict: Be ruthless. If Lenient: Acknowledge improvements).

**JD:**
{jd}

**RESUME:**
{resume}`
  },
  {
    id: 'gap',
    title: "Gap Analysis",
    desc: "Identify missing skills and weak points.",
    requires: ['resume', 'jd'],
    customLabel: null,
    template: `You are a **Hiring Manager** in the **{industry}** field.
**TASK:** Perform a constructive Gap Analysis.
**OUTPUT:**
1. **The Gaps (Table):** | Missing/Weak Skill | Importance | Actionable Fix |
2. **The Strengths:** What makes this candidate a contender?
3. **Bridge Strategy:** Advice on how to address the biggest gap in an interview.

**JD:** {jd}
**RESUME:** {resume}`
  },
  {
    id: 'summary',
    title: "Professional Summary",
    desc: "Draft 3 powerful summary versions.",
    requires: ['jobTitle', 'resume', 'jd'],
    customLabel: null,
    template: `You are a **Professional Resume Writer**.
**TASK:** Draft 3 summaries for a **{jobTitle}** application.
1. **The Perfect Fit:** Aligns with keywords. Safe, polished.
2. **The Disruptor:** Focuses on metrics and impact. Bold.
3. **The Pivot:** Focuses on transferable skills.

**CONSTRAINT:** Under 4 lines each. Active voice.

**RESUME:** {resume}
**JD:** {jd}`
  },
  {
    id: 'bullets',
    title: "Rewrite Experience",
    desc: "Enhance bullets with metrics/action verbs.",
    requires: ['customInput'],
    customLabel: "Paste bullet points to rewrite",
    customPlaceholder: "e.g., - Managed a team...",
    template: `You are a **Senior Editor**. Rewrite these bullets to be punchy and metric-driven.
**INPUT:** {customInput}
**OUTPUT:** For each: 1. **Before** 2. **After** (Stronger) 3. **Why**.`
  },
  {
    id: 'skills',
    title: "Skills & Keywords",
    desc: "Extract top technical and soft skills.",
    requires: ['jd'],
    customLabel: null,
    template: `You are an **Industry Analyst** for **{industry}**.
**TASK:** Analyze the JD for critical success factors.
**OUTPUT:**
1. **Core Technical Skills:** Top 5 hard skills.
2. **Future-Proofing:** Emerging skills mentioned/implied.
3. **Soft Skills:** Cultural traits valued.
4. **Keywords Table:** | Keyword | Category | Priority |

**JD:** {jd}`
  }
];

const EXTRA_PROMPTS = [
  {
    id: 'ats',
    title: "ATS Optimization",
    desc: "Deep dive formatting check.",
    requires: ['jd', 'resume'],
    template: `You are an **ATS Specialist**. Audit the resume for parsing risks.
**OUTPUT:**
1. **Formatting Flags:** Columns, graphics, fonts?
2. **Keyword Density:** Check top 5 JD keywords in Resume.
3. **Header Check:** Is contact info parseable?

**JD:** {jd}
**RESUME:** {resume}`
  },
  {
    id: 'cover',
    title: "✨ Cover Letter",
    desc: "Draft a compelling cover letter.",
    requires: ['jobTitle', 'resume', 'jd'],
    template: `You are a **Copywriter**. Write a cover letter for **{jobTitle}** in **{industry}**.
**HOOK:** Start with value, not "I am applying".
**BODY:** Connect 2 resume wins to JD needs.
**CLOSE:** Confident CTA.

**RESUME:** {resume}
**JD:** {jd}`
  },
  {
    id: 'interview',
    title: "✨ Interview Prep",
    desc: "Predict questions & STAR answers.",
    requires: ['jd', 'resume'],
    template: `You are an **Interview Coach**. Predict top 5 questions for this JD.
**OUTPUT:** Question, Why they ask, and a STAR Answer Strategy using my resume.
**JD:** {jd}
**RESUME:** {resume}`
  },
  {
    id: 'linkedin',
    title: "✨ LinkedIn Outreach",
    desc: "Connection messages for recruiters.",
    requires: ['jobTitle', 'currentRole', 'jd'],
    template: `Draft 3 LinkedIn connection messages to a Hiring Manager for **{jobTitle}**.
1. **The Admirer** (Company focus)
2. **The Value Add** (My background focus)
3. **Short & Sweet**
**MY ROLE:** {currentRole}
**JD:** {jd}`
  },
  {
    id: 'salary',
    title: "✨ Salary Negotiator",
    desc: "Negotiation scripts.",
    requires: ['jobTitle', 'jd', 'resume'],
    template: `Script a salary negotiation for **{jobTitle}**.
1. **Soft Launch Email**
2. **Phone Script** (Ask + Justification from Resume/JD)
3. **Objection Handling**
**JD:** {jd}
**RESUME:** {resume}`
  },
  {
    id: 'quiz',
    title: "✨ Technical Quiz",
    desc: "3 hard questions to test readiness.",
    requires: ['jd', 'industry'],
    template: `Generate a mini-quiz for this **{industry}** role.
3 Questions (Technical/Scenario). For each, give a "Junior Answer" vs "Senior Answer".
**JD:** {jd}`
  }
];

const DETAIL_LEVELS = [
  { value: 1, label: 'Brief', instruction: 'Keep the response extremely concise, brief, and to the point.' },
  { value: 2, label: 'Normal', instruction: 'Provide a standard, balanced response.' },
  { value: 3, label: 'Detailed', instruction: 'Provide a comprehensive, detailed response.' },
  { value: 4, label: 'Extensive', instruction: 'Provide an extensive, deep-dive analysis.' }
];

export default function App() {
  const [apiKey, setApiKey] = useState('');
  const [activeTab, setActiveTab] = useState('setup');
  const [messages, setMessages] = useState([]);
  const [isLoading, setIsLoading] = useState(false);
  const [isAutoFilling, setIsAutoFilling] = useState(false);
  const [showSettings, setShowSettings] = useState(false);
  const [confirmClear, setConfirmClear] = useState(false);
  const [isPromptBarExpanded, setIsPromptBarExpanded] = useState(true);
  const [showExtraPrompts, setShowExtraPrompts] = useState(false);
  const [isRevisedCV, setIsRevisedCV] = useState(false);
  const [sidebarWidth, setSidebarWidth] = useState(320); 
  
  const [context, setContext] = useState({
    resume: '', 
    resumeFile: null, 
    jd: '',
    jobTitle: '',
    currentRole: '',
    targetRole: '',
    industry: ''
  });

  const [selectedPrompt, setSelectedPrompt] = useState(null); 
  const messagesEndRef = useRef(null);
  const chatContainerRef = useRef(null);
  const fileInputRef = useRef(null);
  const revisedFileInputRef = useRef(null);
  const sidebarRef = useRef(null);

  useEffect(() => {
    const savedKey = localStorage.getItem('gemini_api_key');
    const savedContext = localStorage.getItem('career_crafter_context');
    if (savedKey) setApiKey(savedKey);
    if (savedContext) {
      try { setContext(JSON.parse(savedContext)); } catch (e) { console.error("Context load error"); }
    }
  }, []);

  useEffect(() => {
    try { localStorage.setItem('career_crafter_context', JSON.stringify(context)); } catch (e) {}
  }, [context]);

  useEffect(() => {
    if (apiKey) localStorage.setItem('gemini_api_key', apiKey);
  }, [apiKey]);

  useEffect(() => { scrollToBottom(); }, [messages]);
  useEffect(() => { if (selectedPrompt) setIsPromptBarExpanded(true); }, [selectedPrompt]);

  const scrollToBottom = () => messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  const handleContextChange = (field, value) => setContext(prev => ({ ...prev, [field]: value }));
  const isUrl = (text) => text && text.trim().match(/^https?:\/\//i);

  const startResizing = (mouseDownEvent) => {
    const startX = mouseDownEvent.clientX;
    const startWidth = sidebarWidth;
    const onMouseMove = (mouseMoveEvent) => {
      const newWidth = startWidth + (mouseMoveEvent.clientX - startX);
      if (newWidth > 250 && newWidth < 600) setSidebarWidth(newWidth);
    };
    const onMouseUp = () => {
      document.removeEventListener("mousemove", onMouseMove);
      document.removeEventListener("mouseup", onMouseUp);
    };
    document.addEventListener("mousemove", onMouseMove);
    document.addEventListener("mouseup", onMouseUp);
  };

  const handleClearChat = (e) => {
    e.stopPropagation(); 
    if (confirmClear) {
      setMessages([]); 
      setConfirmClear(false);
      setIsRevisedCV(false);
    } else {
      setConfirmClear(true);
      setTimeout(() => setConfirmClear(false), 3000);
    }
  };

  const handleHumanize = async (e) => {
    e.stopPropagation();
    if (messages.length === 0 || isLoading) return;
    const lastModelMsg = [...messages].reverse().find(m => m.role === 'model');
    if (!lastModelMsg) return;

    setIsLoading(true);
    const promptText = `Rewrite the following text to sound more natural, human, and conversational. Avoid corporate jargon and AI-sounding patterns.\n\nTEXT:\n${lastModelMsg.content}`;

    if (!apiKey) {
      setTimeout(() => {
        setMessages(prev => [...prev, { role: 'user', content: 'Humanizing last response...' }, { role: 'model', content: "Here is a simplified, human-sounding version of the text. (Demo Mode)" }]);
        setIsLoading(false);
      }, 1000);
      return;
    }

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ role: 'user', parts: [{ text: promptText }] }] })
      });
      const data = await response.json();
      const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Could not humanize.";
      setMessages(prev => [...prev, { role: 'user', content: 'Humanizing last response...' }, { role: 'model', content: aiText }]);
    } catch (e) {
      console.error(e);
    } finally {
      setIsLoading(false);
    }
  };

  const handleScrollToTop = () => {
    if (chatContainerRef.current) {
      chatContainerRef.current.scrollTo({ top: 0, behavior: 'smooth' });
    }
  };

  const handleScrollToBottom = () => {
    if (chatContainerRef.current) {
      chatContainerRef.current.scrollTo({ top: chatContainerRef.current.scrollHeight, behavior: 'smooth' });
    }
  };

  const processFile = (file, isRevised = false) => {
    if (file.type === 'text/plain' || file.name.endsWith('.md') || file.name.endsWith('.txt')) {
      const reader = new FileReader();
      reader.onload = (event) => {
        const text = event.target.result;
        handleContextChange('resume', text);
        handleContextChange('resumeFile', null); 
        if(isRevised) {
          setIsRevisedCV(true);
          runScoreCard(true, { resume: text, resumeFile: null });
        } else {
          detectDetails({ resume: text, resumeFile: null });
        }
      };
      reader.readAsText(file);
    } else if (['application/pdf', 'image/png', 'image/jpeg', 'image/webp'].includes(file.type)) {
      const reader = new FileReader();
      reader.onload = (event) => {
        const base64Data = event.target.result.split(',')[1];
        const fileObj = { name: file.name, type: file.type, data: base64Data };
        handleContextChange('resumeFile', fileObj);
        handleContextChange('resume', ''); 
        if(isRevised) {
          setIsRevisedCV(true);
          runScoreCard(true, { resume: '', resumeFile: fileObj });
        } else {
          detectDetails({ resume: '', resumeFile: fileObj });
        }
      };
      reader.readAsDataURL(file);
    } else {
      alert("Unsupported file type.");
    }
  };

  const handleFileSelect = (e) => {
    const file = e.target.files[0];
    if (file) processFile(file, false);
  };

  const handleRevisedFileSelect = (e) => {
    const file = e.target.files[0];
    if (file) {
      processFile(file, true);
      setActiveTab('chat');
    }
  };

  const removeResumeFile = () => {
    handleContextChange('resumeFile', null);
    if (fileInputRef.current) fileInputRef.current.value = '';
  };

  const detectDetails = async (activeContext) => {
    if ((!activeContext.resume && !activeContext.resumeFile) && !context.jd) return;
    setIsAutoFilling(true);
    if (!apiKey) {
      setTimeout(() => {
        setContext(prev => ({ ...prev, jobTitle: "Senior PM", targetRole: "Product Lead", currentRole: "PM", industry: "Fintech" }));
        setIsAutoFilling(false);
      }, 1000);
      return;
    }
    try {
      const tools = isUrl(context.jd) ? [{ google_search: {} }] : [];
      const parts = [{ text: `Extract JSON: { "jobTitle": "...", "targetRole": "...", "currentRole": "...", "industry": "..." } based on Resume and JD. Look for Industry in both.` }];
      if (activeContext.resumeFile) parts.push({ inlineData: { mimeType: activeContext.resumeFile.type, data: activeContext.resumeFile.data } });
      else parts[0].text += `\nRESUME: ${activeContext.resume}`;
      parts[0].text += `\nJD: ${context.jd}`; 

      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ role: 'user', parts: parts }], tools })
      });
      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
      if (text) {
        const json = JSON.parse(text.match(/\{[\s\S]*\}/)?.[0] || '{}');
        setContext(prev => ({ ...prev, ...json }));
      }
    } catch (e) { console.error(e); } 
    finally { setIsAutoFilling(false); }
  };

  const runScoreCard = (lenient, overrideContext = null) => {
    const scorePrompt = MAIN_PROMPTS.find(p => p.id === 'score');
    if (scorePrompt) {
      setSelectedPrompt({
        ...scorePrompt,
        template: scorePrompt.template,
        customInput: '',
        detailLevel: 2,
        isLenient: lenient 
      });
    }
  };

  const openPromptConfig = (prompt) => {
    setSelectedPrompt({ ...prompt, template: prompt.template, customInput: '', detailLevel: 2 });
  };

  const executeRunPrompt = async () => {
    setIsLoading(true);
    
    // DEMO MODE HANDLER
    if (!apiKey) {
      setTimeout(() => {
        const mockResponse = MOCK_RESPONSES[selectedPrompt.id] || "Demo response content. Please add API Key for real analysis.";
        // Clean title in chat (no stars)
        const newUserMsg = { role: 'user', content: selectedPrompt.title };
        setMessages(prev => [...prev, newUserMsg, { role: 'model', content: mockResponse }]);
        setIsLoading(false);
        setSelectedPrompt(null);
        // Do NOT auto-collapse prompt bar as requested
        // setIsPromptBarExpanded(false); 
      }, 1500);
      return;
    }

    const scoreMode = (selectedPrompt.id === 'score' && (selectedPrompt.isLenient || isRevisedCV)) 
      ? "LENIENT MODE (Highlight improvements, show progress)" 
      : "STRICT MODE (Be extremely critical)";

    let promptText = selectedPrompt.template;
    const activeRes = context.resumeFile ? "(See attached file)" : (context.resume || "[NO RESUME]");
    
    promptText = promptText.replace('{resume}', activeRes)
                           .replace('{jd}', context.jd)
                           .replace('{jobTitle}', context.jobTitle)
                           .replace('{currentRole}', context.currentRole)
                           .replace('{targetRole}', context.targetRole)
                           .replace('{industry}', context.industry)
                           .replace('{customInput}', selectedPrompt.customInput)
                           .replace('{scoreMode}', scoreMode);

    promptText += `\n\n[SYSTEM: ${DETAIL_LEVELS.find(l => l.value === selectedPrompt.detailLevel)?.instruction}]`;

    // Only showing TITLE in user chat history, clean (no stars)
    const newUserMsg = { role: 'user', content: selectedPrompt.title };
    setMessages(prev => [...prev, newUserMsg]);
    setActiveTab('chat');
    setSelectedPrompt(null);
    // Do NOT auto-collapse prompt bar as requested
    // setIsPromptBarExpanded(false);

    try {
      const parts = [{ text: promptText }];
      if (context.resumeFile && selectedPrompt.requires.includes('resume')) {
        parts.push({ inlineData: { mimeType: context.resumeFile.type, data: context.resumeFile.data } });
      }
      
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ role: 'user', parts: parts }] })
      });
      const data = await response.json();
      const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Error generating.";
      setMessages(prev => [...prev, { role: 'model', content: aiText }]);
    } catch (e) {
      setMessages(prev => [...prev, { role: 'system', content: "Error: " + e.message }]);
    } finally {
      setIsLoading(false);
    }
  };

  // --- Components ---

  const Sidebar = () => (
    <div className="flex flex-col h-full overflow-hidden shrink-0 bg-slate-50 border-r border-slate-200" style={{ width: sidebarWidth }}>
      {/* Header */}
      <div className="p-4 border-b border-slate-200 bg-white flex justify-between items-center">
        <div className="flex items-center gap-2 text-indigo-700 font-bold text-lg">
          <Briefcase className="w-6 h-6" />
          <span className="truncate">Career Crafter</span>
        </div>
        <button onClick={() => setShowSettings(!showSettings)} className="p-2 hover:bg-slate-100 rounded-full text-slate-500">
          <Settings className="w-5 h-5" />
        </button>
      </div>

      {showSettings && (
        <div className="p-4 bg-indigo-50 border-b border-indigo-100 animate-in slide-in-from-top-2">
          <label className="block text-xs font-semibold text-indigo-800 mb-1">GOOGLE GEMINI API KEY</label>
          <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} className="w-full p-2 text-sm border border-indigo-200 rounded" placeholder="AIzaSy..." />
        </div>
      )}

      <div className="flex-1 overflow-y-auto p-4 space-y-6">
        
        {/* Documents (Top Priority) */}
        <div>
          <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 flex items-center gap-1">
            <FileText className="w-3 h-3" /> Documents
          </h3>
          
          <div className="space-y-4">
            {/* JD First */}
            <div className={`p-3 rounded-lg border-2 transition-colors ${context.jd ? 'border-green-200 bg-green-50' : 'border-slate-200 bg-white'}`}>
              <div className="flex justify-between items-center mb-2">
                <span className="text-sm font-semibold text-slate-700">1. Job Description</span>
                {context.jd && !isUrl(context.jd) && <CheckCircle2 className="w-4 h-4 text-green-600" />}
              </div>
              <textarea 
                className="w-full h-20 text-xs p-2 border rounded resize-none mb-2 focus:outline-none focus:border-indigo-400"
                placeholder="Paste JD text OR Link..."
                value={context.jd}
                onChange={(e) => handleContextChange('jd', e.target.value)}
              />
            </div>

            {/* Resume Second */}
            <div className={`p-3 rounded-lg border-2 transition-colors relative group ${context.resume || context.resumeFile ? 'border-green-200 bg-green-50' : 'border-slate-200 bg-white'}`}>
              <div className="flex justify-between items-center mb-2">
                <span className="text-sm font-semibold text-slate-700">2. Your Resume</span>
                {(context.resume || context.resumeFile) && <CheckCircle2 className="w-4 h-4 text-green-600" />}
              </div>
              {context.resumeFile ? (
                <div className="bg-white border border-green-200 rounded p-2 flex items-start gap-2">
                  <FileType className="w-5 h-5 text-red-500" />
                  <p className="text-xs text-slate-700 truncate flex-1">{context.resumeFile.name}</p>
                  <button onClick={removeResumeFile}><X className="w-4 h-4 text-slate-400" /></button>
                </div>
              ) : (
                <textarea className="w-full h-20 text-xs p-2 border rounded resize-none mb-2 focus:outline-none focus:border-indigo-400" placeholder="Paste text or Upload..." value={context.resume} onChange={(e) => handleContextChange('resume', e.target.value)} />
              )}
              <div className="mt-2">
                <label className="cursor-pointer bg-indigo-50 hover:bg-indigo-100 text-indigo-700 text-xs px-3 py-2 rounded flex items-center justify-center gap-2 transition-colors font-medium">
                  <Upload className="w-3 h-3" /> Auto-Scan Resume
                  <input ref={fileInputRef} type="file" className="hidden" accept=".pdf,.txt,.md,.png,.jpg,.webp" onChange={handleFileSelect} />
                </label>
              </div>
            </div>
          </div>
        </div>

        {/* Core Context (Derived) */}
        <div>
          <div className="flex justify-between items-center mb-2">
             <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-1">
               <User className="w-3 h-3" /> Core Context
             </h3>
             <button 
               onClick={() => detectDetails(context)} 
               disabled={isAutoFilling}
               className="text-[10px] bg-indigo-100 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-200 flex items-center gap-1 disabled:opacity-50"
             >
               {isAutoFilling ? <span className="animate-spin">⌛</span> : <Sparkles className="w-3 h-3"/>} 
               Auto-Fill
             </button>
          </div>
          <div className="space-y-3">
            <input className="w-full p-2 border rounded text-xs bg-slate-50" placeholder="Target Job Title" value={context.jobTitle} onChange={(e) => handleContextChange('jobTitle', e.target.value)} />
            <input className="w-full p-2 border rounded text-xs bg-slate-50" placeholder="Industry" value={context.industry} onChange={(e) => handleContextChange('industry', e.target.value)} />
            <div className="grid grid-cols-2 gap-2">
               <input className="p-2 border rounded text-xs bg-slate-50" placeholder="Current Role" value={context.currentRole} onChange={(e) => handleContextChange('currentRole', e.target.value)} />
               <input className="p-2 border rounded text-xs bg-slate-50" placeholder="Target Role" value={context.targetRole} onChange={(e) => handleContextChange('targetRole', e.target.value)} />
            </div>
          </div>
        </div>
      </div>

      {/* Credit Footer */}
      <div className="p-4 border-t border-slate-200 bg-white text-center">
        <a href="https://www.linkedin.com/in/tejaswee98/" target="_blank" rel="noreferrer" className="inline-flex items-center gap-2 text-xs font-medium text-slate-500 hover:text-[#0077b5] transition-colors">
          <Linkedin className="w-3 h-3" /> Built by Tejaswee
        </a>
      </div>
    </div>
  );

  return (
    <div className="flex flex-col md:flex-row h-screen min-h-screen bg-slate-100 font-sans text-slate-900 overflow-hidden">
      {/* Custom Scrollbar Styles */}
      <style>{`
        .custom-scrollbar {
          scrollbar-width: auto;
          scrollbar-color: #94a3b8 #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar {
          width: 16px;
          height: 16px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
          background-color: #f8fafc;
          border-left: 1px solid #cbd5e1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
          background-color: #64748b;
          border-radius: 8px;
          border: 3px solid #e2e8f0;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
          background-color: #475569;
        }
      `}</style>

      {/* Mobile Header */}
      <div className="md:hidden bg-white p-4 border-b flex justify-between items-center shrink-0">
        <span className="font-bold text-indigo-700 flex items-center gap-2"><Briefcase className="w-5 h-5"/> Career Crafter</span>
        <button onClick={() => setActiveTab(activeTab === 'setup' ? 'chat' : 'setup')} className="text-sm bg-slate-100 px-3 py-1 rounded">{activeTab === 'setup' ? 'Chat' : 'Setup'}</button>
      </div>

      <div className={`${activeTab === 'setup' ? 'block' : 'hidden'} md:block h-full shrink-0 flex`}>
        <Sidebar />
        {/* Resize Handle */}
        <div 
          className="w-1 cursor-col-resize hover:bg-indigo-300 transition-colors flex items-center justify-center bg-slate-200"
          onMouseDown={startResizing}
        >
          <GripVertical className="w-3 h-3 text-slate-400" />
        </div>
      </div>

      <div className={`flex-1 flex flex-col h-full ${activeTab === 'chat' ? 'block' : 'hidden'} md:block relative overflow-hidden`}>
        {/* Chat Area */}
        <div className="flex-1 relative min-h-0 bg-slate-50/50 flex flex-col overflow-hidden">
           {messages.length === 0 ? (
             <div className="flex-1 overflow-y-auto flex flex-col items-center justify-center p-8 text-center text-slate-500 custom-scrollbar">
               <div className="w-20 h-20 bg-white rounded-full flex items-center justify-center mb-6 shadow-sm border border-slate-100">
                 <Sparkles className="w-10 h-10 text-indigo-500" />
               </div>
               <h2 className="text-2xl font-bold text-slate-800 mb-3">Welcome to Career Crafter</h2>
               <p className="max-w-md text-sm leading-relaxed mb-8">
                 Your AI-powered career strategist. Follow these steps to get started:
               </p>
               
               <div className="grid gap-4 max-w-2xl w-full grid-cols-1 md:grid-cols-3 text-left">
                 <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:border-indigo-200 transition-colors">
                   <div className="bg-indigo-50 w-8 h-8 rounded-lg flex items-center justify-center text-indigo-600 font-bold mb-3"><KeyRound className="w-4 h-4"/></div>
                   <h3 className="font-semibold text-slate-800 mb-1">1. Add API Key</h3>
                   <p className="text-xs">Click the <Settings className="w-3 h-3 inline"/> icon top-left to add your Gemini API Key.</p>
                 </div>
                 <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:border-indigo-200 transition-colors">
                   <div className="bg-indigo-50 w-8 h-8 rounded-lg flex items-center justify-center text-indigo-600 font-bold mb-3"><Upload className="w-4 h-4"/></div>
                   <h3 className="font-semibold text-slate-800 mb-1">2. Upload Context</h3>
                   <p className="text-xs">Upload Resume & Paste JD in the sidebar to auto-detect details.</p>
                 </div>
                 <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:border-indigo-200 transition-colors">
                   <div className="bg-indigo-50 w-8 h-8 rounded-lg flex items-center justify-center text-indigo-600 font-bold mb-3"><Play className="w-4 h-4"/></div>
                   <h3 className="font-semibold text-slate-800 mb-1">3. Run Prompts</h3>
                   <p className="text-xs">Select "CV Scorecard" below to start your analysis.</p>
                 </div>
               </div>

               <div className="mt-8 flex items-center gap-2 text-xs text-slate-400 bg-slate-50 px-4 py-2 rounded-full border border-slate-100">
                 {!apiKey ? (
                   <span className="flex items-center gap-1 text-orange-500 font-medium"><AlertTriangle className="w-3 h-3"/> Demo Mode Active (Mock Data)</span>
                 ) : (
                   <span className="flex items-center gap-1 text-green-600 font-medium"><CheckCircle2 className="w-3 h-3"/> API Key Active</span>
                 )}
               </div>
             </div>
           ) : (
             <div ref={chatContainerRef} className="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 outline-none pb-32 custom-scrollbar">
                {messages.map((msg, idx) => (
                  <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                    <div className={`max-w-3xl rounded-2xl p-5 shadow-sm ${
                      msg.role === 'user' 
                        ? 'bg-indigo-600 text-white rounded-br-none rounded-tr-none' 
                        : 'bg-white border border-slate-200 text-slate-800 rounded-bl-none'
                    }`}>
                       {msg.role === 'user' ? (
                         <div className="text-sm font-medium">{msg.content}</div> // Cleaner User Bubble
                       ) : (
                         <MarkdownRenderer content={msg.content} />
                       )}
                    </div>
                  </div>
                ))}
                {isLoading && <div className="flex justify-start"><div className="bg-white border p-4 rounded-2xl shadow-sm flex gap-2"><div className="w-2 h-2 bg-indigo-500 rounded-full animate-bounce"/></div></div>}
                <div ref={messagesEndRef} />
             </div>
           )}
           
           {/* Floating Scroll Controls */}
           {messages.length > 0 && (
             <div className="absolute bottom-4 right-8 flex flex-col gap-2 z-20">
               <button onClick={handleScrollToTop} className="p-2 bg-white border shadow-lg rounded-full text-slate-500 hover:text-indigo-600"><ArrowUp className="w-4 h-4" /></button>
               <button onClick={handleScrollToBottom} className="p-2 bg-white border shadow-lg rounded-full text-slate-500 hover:text-indigo-600"><ArrowDown className="w-4 h-4" /></button>
             </div>
           )}
        </div>

        {/* Prompt Bar (Fixed Bottom) */}
        <div className="bg-white border-t border-slate-200 p-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-10 shrink-0 relative transition-all duration-300" style={{ height: isPromptBarExpanded ? 'auto' : '50px' }}>
          <div className="max-w-6xl mx-auto">
            {/* Header */}
            <div className="flex justify-between items-center mb-2 cursor-pointer" onClick={() => setIsPromptBarExpanded(!isPromptBarExpanded)}>
               <div className="flex items-center gap-2 group">
                 <span className="text-xs font-bold text-slate-400 uppercase tracking-wider group-hover:text-indigo-600">Prompt Sequence</span>
                 {isPromptBarExpanded ? <ChevronDown className="w-3 h-3 text-slate-400"/> : <ChevronUp className="w-3 h-3 text-slate-400"/>}
               </div>
               <div className="flex gap-2" onClick={(e) => e.stopPropagation()}>
                 <button onClick={handleHumanize} className="text-xs bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full hover:bg-indigo-100 flex items-center gap-1 transition-colors border border-indigo-100 font-medium">
                   <Wand2 className="w-3 h-3" /> Humanize It
                 </button>
                 <button onClick={handleClearChat} className={`text-xs flex items-center gap-1 px-3 py-1 rounded-full transition-colors font-medium ${confirmClear ? 'bg-red-500 text-white' : 'text-red-400 hover:bg-red-50 border border-red-100'}`}>
                   {confirmClear ? "Confirm?" : <><Trash2 className="w-3 h-3" /> Clear History</>}
                 </button>
               </div>
            </div>

            {/* Content */}
            {isPromptBarExpanded && (
              <div className="animate-in slide-in-from-bottom-2">
                {selectedPrompt ? (
                  <div className={`grid gap-4 pt-2 ${selectedPrompt.id === 'score' ? 'grid-cols-1' : 'grid-cols-1 md:grid-cols-2'}`}>
                    
                    {/* Hide Textarea if Score Prompt */}
                    {selectedPrompt.id !== 'score' && (
                      <div>
                        <label className="block text-xs font-semibold text-slate-500 mb-1">PROMPT TEMPLATE (EDITABLE)</label>
                        <textarea 
                          className="w-full h-24 p-2 border rounded text-xs resize-none outline-none focus:border-indigo-400 bg-slate-50"
                          value={selectedPrompt.template} 
                          onChange={(e) => setSelectedPrompt({...selectedPrompt, template: e.target.value})} 
                        />
                      </div>
                    )}

                    <div className="space-y-3">
                      {selectedPrompt.customLabel && <input className="w-full p-2 border rounded text-sm focus:border-indigo-400" placeholder={selectedPrompt.customPlaceholder} value={selectedPrompt.customInput} onChange={(e) => setSelectedPrompt({...selectedPrompt, customInput: e.target.value})} />}
                      <div>
                        <label className="text-xs font-semibold text-slate-500 flex justify-between"><span>DETAIL LEVEL</span> <span className="text-indigo-600">{DETAIL_LEVELS.find(l=>l.value===selectedPrompt.detailLevel).label}</span></label>
                        <input type="range" min="1" max="4" value={selectedPrompt.detailLevel} onChange={(e) => setSelectedPrompt({...selectedPrompt, detailLevel: parseInt(e.target.value)})} className="w-full h-1 bg-slate-200 rounded appearance-none cursor-pointer accent-indigo-600" />
                      </div>
                      <div className="flex gap-2">
                        <button onClick={() => setSelectedPrompt(null)} className="flex-1 py-2 rounded bg-slate-100 text-slate-600 text-xs font-bold hover:bg-slate-200">Cancel</button>
                        <button onClick={executeRunPrompt} className="flex-1 py-2 rounded bg-indigo-600 text-white text-xs font-bold flex items-center justify-center gap-1 hover:bg-indigo-700">Run <Send className="w-3 h-3" /></button>
                      </div>
                    </div>
                  </div>
                ) : (
                  <div className="flex gap-3 overflow-x-auto pb-2 snap-x no-scrollbar pt-2 items-center custom-scrollbar">
                    {MAIN_PROMPTS.map((prompt, i) => (
                      <button key={prompt.id} onClick={() => openPromptConfig(prompt)} className={`snap-start flex-shrink-0 w-48 p-3 rounded-lg border text-left transition-all hover:border-indigo-400 bg-white border-slate-200 group relative`}>
                        <div className="absolute top-2 right-2 text-indigo-100 group-hover:text-indigo-600"><Edit className="w-3 h-3" /></div>
                        <div className="flex items-center gap-2 mb-1">
                          <span className="w-5 h-5 rounded bg-indigo-100 text-indigo-700 flex items-center justify-center text-xs font-bold">{i+1}</span>
                          <span className="font-bold text-slate-700 text-xs">{prompt.title}</span>
                        </div>
                        <div className="text-[10px] text-slate-500 line-clamp-2">{prompt.desc}</div>
                      </button>
                    ))}
                    
                    <button onClick={() => setShowExtraPrompts(!showExtraPrompts)} className="flex-shrink-0 p-3 rounded-lg border border-dashed border-slate-300 text-slate-500 hover:bg-slate-50 hover:text-indigo-600 flex flex-col items-center justify-center gap-1 w-24">
                      <MoreHorizontal className="w-5 h-5" />
                      <span className="text-[10px] font-medium">{showExtraPrompts ? "Hide Extras" : "More Features"}</span>
                    </button>

                    <label className="flex-shrink-0 p-3 rounded-lg bg-green-50 border border-green-200 text-green-700 hover:bg-green-100 cursor-pointer flex flex-col items-center justify-center gap-1 w-32 text-center transition-colors">
                      <RefreshCw className="w-4 h-4" />
                      <span className="text-[10px] font-bold leading-tight">Upload Revised<br/>Resume</span>
                      <input ref={revisedFileInputRef} type="file" className="hidden" accept=".pdf,.txt,.md,.png,.jpg" onChange={handleRevisedFileSelect} />
                    </label>

                    {showExtraPrompts && EXTRA_PROMPTS.map((prompt) => (
                      <button key={prompt.id} onClick={() => openPromptConfig(prompt)} className="snap-start flex-shrink-0 w-40 p-3 rounded-lg border text-left hover:border-purple-400 bg-purple-50/50 border-purple-100">
                        <div className="font-bold text-slate-700 text-xs mb-1">{prompt.title}</div>
                        <div className="text-[10px] text-slate-500 line-clamp-2">{prompt.desc}</div>
                      </button>
                    ))}
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}
